(function($){
    $.fn.flexipage=function(options){
        var opts=$.extend({},$.fn.flexipage.defaults,options);
        $.fn.flexipage.options=opts;
        function buildPager($target,HTML){
            if(opts.pager_selector==false){
                $target.before('<div class="pager">'+HTML+"</div>");
                $target.after('<div class="pager">'+HTML+"</div>");
                opts.pager_selector=".pager"
            }else{
                $(opts.pager_selector,$.fn.flexipage.options.parent_cont).html(HTML)
            }
        }
        return this.each(function(){
            if(opts.pager==true){
                opts.navigation==false
            }
            if(opts.navigation==true){
                opts.pager==false
            }
            var $target=$(this);
            $target.data("opts",opts);
            opts.wrapper=$target.closest("div");
            opts.actual=opts.firstpage;
            opts.total_pages=Math.ceil(($(opts.element,$target).length)/opts.perpage);
            if(opts.pager==true){
                opts.navigation==false
            }
            if(opts.navigation==true){
                opts.pager==false
            }
            if(opts.pager==true){
                (opts.showcounter==true)?opts.showcounter='<li style="margin:5px 12px 0px 0px;"><span class="actual"></span> / <span class="total">'+opts.total_pages+"</span></li>":opts.showcounter="";
                var pagerHTML='<li class="prev"><a href="javascript:void(0)" class="tool-button bg-color-blue fg-color-white">'+opts.prev_txt+"</a></li>"+opts.showcounter+'<li class="next"><a href="javascript:void(0)" class="tool-button bg-color-blue fg-color-white">'+opts.next_txt+"</a></li>";
                buildPager($target,pagerHTML);
                $(opts.pager_selector+" li.next a",opts.wrapper).click(function(e){
                    $("html, body").animate({
                        scrollTop: 0
                    }, 1000);
                    e.preventDefault();
                    if(opts.actual<=(opts.total_pages-1)){
                        $target.selectPage(opts.actual+1)
                    }
                });
                $(opts.pager_selector+" li.prev a",opts.wrapper).click(function(e){
                    $("html, body").animate({
                        scrollTop: 0
                    }, 1000);
                    e.preventDefault();
                    if(opts.actual<=(opts.total_pages+1)){
                        $target.selectPage(opts.actual-1)
                    }
                })
            }
            if(opts.navigation==true){
                var navigationHTML="";
                var actual;
                for(var i=1;i<=opts.total_pages;i++){
                    (opts.firstpage==i)?actual=' class="active" ':actual="";
                    navigationHTML+="<li"+actual+'><a rel="'+i+'" href="javascript:void(0)">'+i+"</a></li>"
                }
                buildPager($target,navigationHTML);
                $(opts.pager_selector+" li a",opts.wrapper).click(function(e){
                    e.preventDefault();
                    var topage=$(this).attr("rel");
                    if(topage<=opts.total_pages&&topage>0){
                        $target.selectPage(topage)
                    }
                })
            }
            if(opts.carousel==true){
                opts.wrapper_width=$(opts.element,$target).width();
                $target.wrap('<div class="flexiwrap"></div>');
                $target.parent().css({
                    overflow:"hidden",
                    position:"relative"
                });
                $target.css({
                    overflow:"hidden",
                    position:"absolute",
                    top:"0px",
                    left:"0px"
                });
                opts.distances=[];
                for(var i=0;i<=opts.total_pages;i++){
                    opts.distances[i]=(i*opts.perpage)*opts.wrapper_width
                }
            }
            $target.selectPage(opts.firstpage)
        })
    };

    $.fn.selectPage=function(n){
        var parent=$(this);
        var opts=parent.data("opts");
        if(n=="next"){
            (opts.actual<opts.total_pages)?n=opts.actual+1:n=opts.total_pages
        }
        if(n=="prev"){
            if(opts.actual>0){
                n=opts.actual-1
            }
        }
        if(n==0||n==undefined){
            n=1
        }
        if(n>1){
            var $selected_items=$(opts.element+":lt("+(n*opts.perpage)+"):gt("+(((n-1)*opts.perpage)-1)+")",parent)
        }else{
            var $selected_items=$(opts.element+":lt("+(n*opts.perpage)+")",parent)
        }
        if(opts.carousel==true){
            parent.animate({
                left:"-"+opts.distances[n-1]+"px"
            },opts.speed,opts.animation)
        }else{
            $selected_items.css(opts.visible_css);
            $(opts.element,parent).not($selected_items).css(opts.hidden_css)
        }
        if(opts.navigation==true){
            $(opts.pager_selector+" li",opts.wrapper).removeClass("active");
            $(opts.pager_selector+" li:eq("+(n-1)+")",opts.wrapper).addClass("active")
        }
        if(opts.pager==true){
            $(opts.pager_selector+" .actual",opts.wrapper).html(n);
            $(opts.pager_selector+" .disabled",opts.wrapper).removeClass("disabled");
            if(n==opts.total_pages){
                $(opts.pager_selector+" .next,",opts.wrapper).addClass("disabled")
            }
            if(n==1){
                $(opts.pager_selector+" .prev",opts.wrapper).addClass("disabled")
            }
        }
        opts.actual=parseInt(n)
    };

    $.fn.flexipage.defaults={
        element:"li",
        pager:true,
        prev_txt:"<i class='icon-arrow-left-2' style='margin-top:4px;'></i>",
        next_txt:"<i class='icon-arrow-right-2' style='margin-top:4px;'></i>",
        pager_selector:false,
        perpage:5,
        showcounter:true,
        hidden_css:{
            display:"none"
        },
        visible_css:{
            display:"block"
        },
        firstpage:1,
        navigation:false,
        carousel:false,
        speed:300,
        animation:"linear"
    }
})(jQuery);